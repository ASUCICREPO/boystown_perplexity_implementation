"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.CicBoystownProjectStack = void 0;
// lib/cic-boystown-project-stack.ts
const cdk = require("aws-cdk-lib");
const dynamodb = require("aws-cdk-lib/aws-dynamodb");
const s3 = require("aws-cdk-lib/aws-s3");
const lambda = require("aws-cdk-lib/aws-lambda");
const apigateway = require("aws-cdk-lib/aws-apigateway");
const iam = require("aws-cdk-lib/aws-iam");
const path = require("path");
class CicBoystownProjectStack extends cdk.Stack {
    constructor(scope, id, props) {
        super(scope, id, props);
        //DynamoDB Table
        const resourcesTable = new dynamodb.Table(this, 'ResourcesTable', {
            partitionKey: { name: 'resourceId', type: dynamodb.AttributeType.STRING },
            sortKey: { name: 'location', type: dynamodb.AttributeType.STRING },
            billingMode: dynamodb.BillingMode.PROVISIONED,
            removalPolicy: cdk.RemovalPolicy.DESTROY,
            timeToLiveAttribute: 'ttl',
        });
        // Auto-scaling for read and write capacity in DynamoDB
        const readScaling = resourcesTable.autoScaleReadCapacity({
            minCapacity: 5,
            maxCapacity: 100
        });
        readScaling.scaleOnUtilization({
            targetUtilizationPercent: 70,
        });
        const writeScaling = resourcesTable.autoScaleWriteCapacity({
            minCapacity: 5,
            maxCapacity: 100
        });
        writeScaling.scaleOnUtilization({
            targetUtilizationPercent: 70,
        });
        //add GSI for resourceType
        resourcesTable.addGlobalSecondaryIndex({
            indexName: 'ResourceTypeIndex',
            partitionKey: { name: 'resourceType', type: dynamodb.AttributeType.STRING },
            sortKey: { name: 'location', type: dynamodb.AttributeType.STRING },
        });
        //S3 BUCKET
        const resourceMetadataBucket = new s3.Bucket(this, 'ResourceMetadataBucket', {
            removalPolicy: cdk.RemovalPolicy.DESTROY,
            autoDeleteObjects: true,
            blockPublicAccess: s3.BlockPublicAccess.BLOCK_ALL,
            encryption: s3.BucketEncryption.S3_MANAGED,
        });
        // Parameter for Perplexity API key
        const perplexityApiKeyParamName = '/cic/perplexity-api-key';
        // Add Resource Lambda
        const addResourceLambda = new lambda.Function(this, 'AddResourceFunction', {
            runtime: lambda.Runtime.NODEJS_18_X,
            handler: 'src/index.handler',
            code: lambda.Code.fromAsset(path.join(__dirname, '../lambda/add-resource')),
            environment: {
                RESOURCES_TABLE: resourcesTable.tableName,
                METADATA_BUCKET: resourceMetadataBucket.bucketName
            },
            timeout: cdk.Duration.seconds(10)
        });
        // Search Resources Lambda
        const searchResourcesLambda = new lambda.Function(this, 'SearchResourcesFunction', {
            runtime: lambda.Runtime.NODEJS_18_X,
            handler: 'src/index.handler',
            code: lambda.Code.fromAsset(path.join(__dirname, '../lambda/search-resources')),
            environment: {
                RESOURCES_TABLE: resourcesTable.tableName,
                RESOURCE_TYPE_INDEX: 'ResourceTypeIndex'
            },
            timeout: cdk.Duration.seconds(10)
        });
        // Get Resource by ID Lambda
        const getResourceByIdLambda = new lambda.Function(this, 'GetResourceByIdFunction', {
            runtime: lambda.Runtime.NODEJS_18_X,
            handler: 'src/index.handler',
            code: lambda.Code.fromAsset(path.join(__dirname, '../lambda/get-resource-by-id')),
            environment: {
                RESOURCES_TABLE: resourcesTable.tableName
            },
            timeout: cdk.Duration.seconds(10)
        });
        // Perplexity Search Lambda
        const perplexitySearchLambda = new lambda.Function(this, 'PerplexitySearchFunction', {
            runtime: lambda.Runtime.NODEJS_18_X,
            handler: 'src/index.handler',
            code: lambda.Code.fromAsset(path.join(__dirname, '../lambda/perplexity-search')),
            environment: {
                RESOURCES_TABLE: resourcesTable.tableName,
                PERPLEXITY_API_KEY_PARAM: perplexityApiKeyParamName // Just use the name string
            },
            timeout: cdk.Duration.seconds(30)
        });
        // Give the Lambda function permission to read the parameter
        perplexitySearchLambda.addToRolePolicy(new iam.PolicyStatement({
            actions: ['ssm:GetParameter'],
            resources: [`arn:aws:ssm:${this.region}:${this.account}:parameter${perplexityApiKeyParamName}`],
            effect: iam.Effect.ALLOW
        }));
        // Grant permissions
        resourcesTable.grantReadWriteData(addResourceLambda);
        resourceMetadataBucket.grantReadWrite(addResourceLambda);
        resourcesTable.grantReadData(searchResourcesLambda);
        resourcesTable.grantReadData(getResourceByIdLambda);
        resourcesTable.grantReadWriteData(perplexitySearchLambda);
        // Create API Gateway
        const api = new apigateway.RestApi(this, 'ResourcesApi', {
            restApiName: 'Boys Town Resources Service',
            description: 'API for managing Boys Town support resources',
            defaultCorsPreflightOptions: {
                allowOrigins: apigateway.Cors.ALL_ORIGINS,
                allowMethods: apigateway.Cors.ALL_METHODS
            }
        });
        // Create resources
        const resources = api.root.addResource('resources');
        const singleResource = resources.addResource('{resourceId}');
        const externalSearch = api.root.addResource('external-search');
        // Add methods
        resources.addMethod('POST', new apigateway.LambdaIntegration(addResourceLambda));
        resources.addMethod('GET', new apigateway.LambdaIntegration(searchResourcesLambda));
        singleResource.addMethod('GET', new apigateway.LambdaIntegration(getResourceByIdLambda));
        externalSearch.addMethod('GET', new apigateway.LambdaIntegration(perplexitySearchLambda));
        // Output the resource names for reference
        new cdk.CfnOutput(this, 'DynamoDBTableName', {
            value: resourcesTable.tableName,
            description: 'The name of the DynamoDB table for resources',
        });
        new cdk.CfnOutput(this, 'S3BucketName', {
            value: resourceMetadataBucket.bucketName,
            description: 'The name of the S3 bucket for resource metadata',
        });
        // Add outputs for the API URL
        new cdk.CfnOutput(this, 'ApiUrl', {
            value: api.url,
            description: 'URL of the API Gateway'
        });
    }
}
exports.CicBoystownProjectStack = CicBoystownProjectStack;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2ljLWJveXN0b3duLXByb2plY3Qtc3RhY2suanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJjaWMtYm95c3Rvd24tcHJvamVjdC1zdGFjay50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFBQSxvQ0FBb0M7QUFDcEMsbUNBQW1DO0FBRW5DLHFEQUFxRDtBQUNyRCx5Q0FBeUM7QUFDekMsaURBQWlEO0FBQ2pELHlEQUF5RDtBQUN6RCwyQ0FBMkM7QUFFM0MsNkJBQTZCO0FBRTdCLE1BQWEsdUJBQXdCLFNBQVEsR0FBRyxDQUFDLEtBQUs7SUFDcEQsWUFBWSxLQUFnQixFQUFFLEVBQVUsRUFBRSxLQUFzQjtRQUM5RCxLQUFLLENBQUMsS0FBSyxFQUFFLEVBQUUsRUFBRSxLQUFLLENBQUMsQ0FBQztRQUV4QixnQkFBZ0I7UUFDaEIsTUFBTSxjQUFjLEdBQUcsSUFBSSxRQUFRLENBQUMsS0FBSyxDQUFDLElBQUksRUFBRSxnQkFBZ0IsRUFBRTtZQUNoRSxZQUFZLEVBQUUsRUFBRSxJQUFJLEVBQUUsWUFBWSxFQUFFLElBQUksRUFBRSxRQUFRLENBQUMsYUFBYSxDQUFDLE1BQU0sRUFBRTtZQUN6RSxPQUFPLEVBQUUsRUFBRSxJQUFJLEVBQUUsVUFBVSxFQUFFLElBQUksRUFBRSxRQUFRLENBQUMsYUFBYSxDQUFDLE1BQU0sRUFBRTtZQUNsRSxXQUFXLEVBQUUsUUFBUSxDQUFDLFdBQVcsQ0FBQyxXQUFXO1lBQzdDLGFBQWEsRUFBRSxHQUFHLENBQUMsYUFBYSxDQUFDLE9BQU87WUFDeEMsbUJBQW1CLEVBQUUsS0FBSztTQUMzQixDQUFDLENBQUM7UUFFSCx1REFBdUQ7UUFDdkQsTUFBTSxXQUFXLEdBQUcsY0FBYyxDQUFDLHFCQUFxQixDQUFDO1lBQ3ZELFdBQVcsRUFBRSxDQUFDO1lBQ2QsV0FBVyxFQUFFLEdBQUc7U0FDakIsQ0FBQyxDQUFDO1FBRUgsV0FBVyxDQUFDLGtCQUFrQixDQUFDO1lBQzdCLHdCQUF3QixFQUFFLEVBQUU7U0FDN0Is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QUU7WUFDM0MsS0FBSyxFQUFFLGNBQWMsQ0FBQyxTQUFTO1lBQy9CLFdBQVcsRUFBRSw4Q0FBOEM7U0FDNUQsQ0FBQyxDQUFDO1FBRUgsSUFBSSxHQUFHLENBQUMsU0FBUyxDQUFDLElBQUksRUFBRSxjQUFjLEVBQUU7WUFDdEMsS0FBSyxFQUFFLHNCQUFzQixDQUFDLFVBQVU7WUFDeEMsV0FBVyxFQUFFLGlEQUFpRDtTQUMvRCxDQUFDLENBQUM7UUFFSCw4QkFBOEI7UUFDOUIsSUFBSSxHQUFHLENBQUMsU0FBUyxDQUFDLElBQUksRUFBRSxRQUFRLEVBQUU7WUFDaEMsS0FBSyxFQUFFLEdBQUcsQ0FBQyxHQUFHO1lBQ2QsV0FBVyxFQUFFLHdCQUF3QjtTQUN0QyxDQUFDLENBQUM7SUFDTCxDQUFDO0NBQ0Y7QUFySkQsMERBcUpDIiwic291cmNlc0NvbnRlbnQiOlsiLy8gbGliL2NpYy1ib3lzdG93bi1wcm9qZWN0LXN0YWNrLnRzXG5pbXBvcnQgKiBhcyBjZGsgZnJvbSAnYXdzLWNkay1saWInO1xuaW1wb3J0IHsgQ29uc3RydWN0IH0gZnJvbSAnY29uc3RydWN0cyc7XG5pbXBvcnQgKiBhcyBkeW5hbW9kYiBmcm9tICdhd3MtY2RrLWxpYi9hd3MtZHluYW1vZGInO1xuaW1wb3J0ICogYXMgczMgZnJvbSAnYXdzLWNkay1saWIvYXdzLXMzJztcbmltcG9ydCAqIGFzIGxhbWJkYSBmcm9tICdhd3MtY2RrLWxpYi9hd3MtbGFtYmRhJztcbmltcG9ydCAqIGFzIGFwaWdhdGV3YXkgZnJvbSAnYXdzLWNkay1saWIvYXdzLWFwaWdhdGV3YXknO1xuaW1wb3J0ICogYXMgaWFtIGZyb20gJ2F3cy1jZGstbGliL2F3cy1pYW0nO1xuaW1wb3J0ICogYXMgc3NtIGZyb20gJ2F3cy1jZGstbGliL2F3cy1zc20nO1xuaW1wb3J0ICogYXMgcGF0aCBmcm9tICdwYXRoJztcblxuZXhwb3J0IGNsYXNzIENpY0JveXN0b3duUHJvamVjdFN0YWNrIGV4dGVuZHMgY2RrLlN0YWNrIHtcbiAgY29uc3RydWN0b3Ioc2NvcGU6IENvbnN0cnVjdCwgaWQ6IHN0cmluZywgcHJvcHM/OiBjZGsuU3RhY2tQcm9wcykge1xuICAgIHN1cGVyKHNjb3BlLCBpZCwgcHJvcHMpO1xuXG4gICAgLy9EeW5hbW9EQiBUYWJsZVxuICAgIGNvbnN0IHJlc291cmNlc1RhYmxlID0gbmV3IGR5bmFtb2RiLlRhYmxlKHRoaXMsICdSZXNvdXJjZXNUYWJsZScsIHtcbiAgICAgIHBhcnRpdGlvbktleTogeyBuYW1lOiAncmVzb3VyY2VJZCcsIHR5cGU6IGR5bmFtb2RiLkF0dHJpYnV0ZVR5cGUuU1RSSU5HIH0sXG4gICAgICBzb3J0S2V5OiB7IG5hbWU6ICdsb2NhdGlvbicsIHR5cGU6IGR5bmFtb2RiLkF0dHJpYnV0ZVR5cGUuU1RSSU5HIH0sXG4gICAgICBiaWxsaW5nTW9kZTogZHluYW1vZGIuQmlsbGluZ01vZGUuUFJPVklTSU9ORUQsXG4gICAgICByZW1vdmFsUG9saWN5OiBjZGsuUmVtb3ZhbFBvbGljeS5ERVNUUk9ZLFxuICAgICAgdGltZVRvTGl2ZUF0dHJpYnV0ZTogJ3R0bCcsXG4gICAgfSk7XG5cbiAgICAvLyBBdXRvLXNjYWxpbmcgZm9yIHJlYWQgYW5kIHdyaXRlIGNhcGFjaXR5IGluIER5bmFtb0RCXG4gICAgY29uc3QgcmVhZFNjYWxpbmcgPSByZXNvdXJjZXNUYWJsZS5hdXRvU2NhbGVSZWFkQ2FwYWNpdHkoe1xuICAgICAgbWluQ2FwYWNpdHk6IDUsXG4gICAgICBtYXhDYXBhY2l0eTogMTAwXG4gICAgfSk7XG5cbiAgICByZWFkU2NhbGluZy5zY2FsZU9uVXRpbGl6YXRpb24oe1xuICAgICAgdGFyZ2V0VXRpbGl6YXRpb25QZXJjZW50OiA3MCxcbiAgICB9KTtcblxuICAgIGNvbnN0IHdyaXRlU2NhbGluZyA9IHJlc291cmNlc1RhYmxlLmF1dG9TY2FsZVdyaXRlQ2FwYWNpdHkoe1xuICAgICAgbWluQ2FwYWNpdHk6IDUsXG4gICAgICBtYXhDYXBhY2l0eTogMTAwXG4gICAgfSk7XG5cbiAgICB3cml0ZVNjYWxpbmcuc2NhbGVPblV0aWxpemF0aW9uKHtcbiAgICAgIHRhcmdldFV0aWxpemF0aW9uUGVyY2VudDogNzAsXG4gICAgfSk7XG5cbiAgICAvL2FkZCBHU0kgZm9yIHJlc291cmNlVHlwZVxuICAgIHJlc291cmNlc1RhYmxlLmFkZEdsb2JhbFNlY29uZGFyeUluZGV4KHtcbiAgICAgIGluZGV4TmFtZTogJ1Jlc291cmNlVHlwZUluZGV4JyxcbiAgICAgIHBhcnRpdGlvbktleTogeyBuYW1lOiAncmVzb3VyY2VUeXBlJywgdHlwZTogZHluYW1vZGIuQXR0cmlidXRlVHlwZS5TVFJJTkcgfSxcbiAgICAgIHNvcnRLZXk6IHsgbmFtZTogJ2xvY2F0aW9uJywgdHlwZTogZHluYW1vZGIuQXR0cmlidXRlVHlwZS5TVFJJTkcgfSxcbiAgICB9KTtcblxuICAgIC8vUzMgQlVDS0VUXG4gICAgY29uc3QgcmVzb3VyY2VNZXRhZGF0YUJ1Y2tldCA9IG5ldyBzMy5CdWNrZXQodGhpcywgJ1Jlc291cmNlTWV0YWRhdGFCdWNrZXQnLCB7XG4gICAgICByZW1vdmFsUG9saWN5OiBjZGsuUmVtb3ZhbFBvbGljeS5ERVNUUk9ZLFxuICAgICAgYXV0b0RlbGV0ZU9iamVjdHM6IHRydWUsXG4gICAgICBibG9ja1B1YmxpY0FjY2VzczogczMuQmxvY2tQdWJsaWNBY2Nlc3MuQkxPQ0tfQUxMLFxuICAgICAgZW5jcnlwdGlvbjogczMuQnVja2V0RW5jcnlwdGlvbi5TM19NQU5BR0VELFxuICAgIH0pO1xuXG4gICAgLy8gUGFyYW1ldGVyIGZvciBQZXJwbGV4aXR5IEFQSSBrZXlcbiAgICBjb25zdCBwZXJwbGV4aXR5QXBpS2V5UGFyYW1OYW1lID0gJy9jaWMvcGVycGxleGl0eS1hcGkta2V5JztcblxuXG4gICAgLy8gQWRkIFJlc291cmNlIExhbWJkYVxuICAgIGNvbnN0IGFkZFJlc291cmNlTGFtYmRhID0gbmV3IGxhbWJkYS5GdW5jdGlvbih0aGlzLCAnQWRkUmVzb3VyY2VGdW5jdGlvbicsIHtcbiAgICAgIHJ1bnRpbWU6IGxhbWJkYS5SdW50aW1lLk5PREVKU18xOF9YLFxuICAgICAgaGFuZGxlcjogJ3NyYy9pbmRleC5oYW5kbGVyJyxcbiAgICAgIGNvZGU6IGxhbWJkYS5Db2RlLmZyb21Bc3NldChwYXRoLmpvaW4oX19kaXJuYW1lLCAnLi4vbGFtYmRhL2FkZC1yZXNvdXJjZScpKSxcbiAgICAgIGVudmlyb25tZW50OiB7XG4gICAgICAgIFJFU09VUkNFU19UQUJMRTogcmVzb3VyY2VzVGFibGUudGFibGVOYW1lLFxuICAgICAgICBNRVRBREFUQV9CVUNLRVQ6IHJlc291cmNlTWV0YWRhdGFCdWNrZXQuYnVja2V0TmFtZVxuICAgICAgfSxcbiAgICAgIHRpbWVvdXQ6IGNkay5EdXJhdGlvbi5zZWNvbmRzKDEwKVxuICAgIH0pO1xuXG4gICAgLy8gU2VhcmNoIFJlc291cmNlcyBMYW1iZGFcbiAgICBjb25zdCBzZWFyY2hSZXNvdXJjZXNMYW1iZGEgPSBuZXcgbGFtYmRhLkZ1bmN0aW9uKHRoaXMsICdTZWFyY2hSZXNvdXJjZXNGdW5jdGlvbicsIHtcbiAgICAgIHJ1bnRpbWU6IGxhbWJkYS5SdW50aW1lLk5PREVKU18xOF9YLFxuICAgICAgaGFuZGxlcjogJ3NyYy9pbmRleC5oYW5kbGVyJyxcbiAgICAgIGNvZGU6IGxhbWJkYS5Db2RlLmZyb21Bc3NldChwYXRoLmpvaW4oX19kaXJuYW1lLCAnLi4vbGFtYmRhL3NlYXJjaC1yZXNvdXJjZXMnKSksXG4gICAgICBlbnZpcm9ubWVudDoge1xuICAgICAgICBSRVNPVVJDRVNfVEFCTEU6IHJlc291cmNlc1RhYmxlLnRhYmxlTmFtZSxcbiAgICAgICAgUkVTT1VSQ0VfVFlQRV9JTkRFWDogJ1Jlc291cmNlVHlwZUluZGV4J1xuICAgICAgfSxcbiAgICAgIHRpbWVvdXQ6IGNkay5EdXJhdGlvbi5zZWNvbmRzKDEwKVxuICAgIH0pO1xuXG4gICAgLy8gR2V0IFJlc291cmNlIGJ5IElEIExhbWJkYVxuICAgIGNvbnN0IGdldFJlc291cmNlQnlJZExhbWJkYSA9IG5ldyBsYW1iZGEuRnVuY3Rpb24odGhpcywgJ0dldFJlc291cmNlQnlJZEZ1bmN0aW9uJywge1xuICAgICAgcnVudGltZTogbGFtYmRhLlJ1bnRpbWUuTk9ERUpTXzE4X1gsXG4gICAgICBoYW5kbGVyOiAnc3JjL2luZGV4LmhhbmRsZXInLFxuICAgICAgY29kZTogbGFtYmRhLkNvZGUuZnJvbUFzc2V0KHBhdGguam9pbihfX2Rpcm5hbWUsICcuLi9sYW1iZGEvZ2V0LXJlc291cmNlLWJ5LWlkJykpLFxuICAgICAgZW52aXJvbm1lbnQ6IHtcbiAgICAgICAgUkVTT1VSQ0VTX1RBQkxFOiByZXNvdXJjZXNUYWJsZS50YWJsZU5hbWVcbiAgICAgIH0sXG4gICAgICB0aW1lb3V0OiBjZGsuRHVyYXRpb24uc2Vjb25kcygxMClcbiAgICB9KTtcblxuICAgIC8vIFBlcnBsZXhpdHkgU2VhcmNoIExhbWJkYVxuICAgIGNvbnN0IHBlcnBsZXhpdHlTZWFyY2hMYW1iZGEgPSBuZXcgbGFtYmRhLkZ1bmN0aW9uKHRoaXMsICdQZXJwbGV4aXR5U2VhcmNoRnVuY3Rpb24nLCB7XG4gICAgICBydW50aW1lOiBsYW1iZGEuUnVudGltZS5OT0RFSlNfMThfWCxcbiAgICAgIGhhbmRsZXI6ICdzcmMvaW5kZXguaGFuZGxlcicsXG4gICAgICBjb2RlOiBsYW1iZGEuQ29kZS5mcm9tQXNzZXQocGF0aC5qb2luKF9fZGlybmFtZSwgJy4uL2xhbWJkYS9wZXJwbGV4aXR5LXNlYXJjaCcpKSxcbiAgICAgIGVudmlyb25tZW50OiB7XG4gICAgICAgIFJFU09VUkNFU19UQUJMRTogcmVzb3VyY2VzVGFibGUudGFibGVOYW1lLFxuICAgICAgICBQRVJQTEVYSVRZX0FQSV9LRVlfUEFSQU06IHBlcnBsZXhpdHlBcGlLZXlQYXJhbU5hbWUgLy8gSnVzdCB1c2UgdGhlIG5hbWUgc3RyaW5nXG4gICAgICB9LFxuICAgICAgdGltZW91dDogY2RrLkR1cmF0aW9uLnNlY29uZHMoMzApXG4gICAgfSk7XG5cbiAgICAvLyBHaXZlIHRoZSBMYW1iZGEgZnVuY3Rpb24gcGVybWlzc2lvbiB0byByZWFkIHRoZSBwYXJhbWV0ZXJcbiAgICBwZXJwbGV4aXR5U2VhcmNoTGFtYmRhLmFkZFRvUm9sZVBvbGljeShuZXcgaWFtLlBvbGljeVN0YXRlbWVudCh7XG4gICAgICBhY3Rpb25zOiBbJ3NzbTpHZXRQYXJhbWV0ZXInXSxcbiAgICAgIHJlc291cmNlczogW2Bhcm46YXdzOnNzbToke3RoaXMucmVnaW9ufToke3RoaXMuYWNjb3VudH06cGFyYW1ldGVyJHtwZXJwbGV4aXR5QXBpS2V5UGFyYW1OYW1lfWBdLFxuICAgICAgZWZmZWN0OiBpYW0uRWZmZWN0LkFMTE9XXG4gICAgfSkpO1xuICAgIC8vIEdyYW50IHBlcm1pc3Npb25zXG4gICAgcmVzb3VyY2VzVGFibGUuZ3JhbnRSZWFkV3JpdGVEYXRhKGFkZFJlc291cmNlTGFtYmRhKTtcbiAgICByZXNvdXJjZU1ldGFkYXRhQnVja2V0LmdyYW50UmVhZFdyaXRlKGFkZFJlc291cmNlTGFtYmRhKTtcbiAgICByZXNvdXJjZXNUYWJsZS5ncmFudFJlYWREYXRhKHNlYXJjaFJlc291cmNlc0xhbWJkYSk7XG4gICAgcmVzb3VyY2VzVGFibGUuZ3JhbnRSZWFkRGF0YShnZXRSZXNvdXJjZUJ5SWRMYW1iZGEpO1xuICAgIHJlc291cmNlc1RhYmxlLmdyYW50UmVhZFdyaXRlRGF0YShwZXJwbGV4aXR5U2VhcmNoTGFtYmRhKTtcblxuICAgIC8vIENyZWF0ZSBBUEkgR2F0ZXdheVxuICAgIGNvbnN0IGFwaSA9IG5ldyBhcGlnYXRld2F5LlJlc3RBcGkodGhpcywgJ1Jlc291cmNlc0FwaScsIHtcbiAgICAgIHJlc3RBcGlOYW1lOiAnQm95cyBUb3duIFJlc291cmNlcyBTZXJ2aWNlJyxcbiAgICAgIGRlc2NyaXB0aW9uOiAnQVBJIGZvciBtYW5hZ2luZyBCb3lzIFRvd24gc3VwcG9ydCByZXNvdXJjZXMnLFxuICAgICAgZGVmYXVsdENvcnNQcmVmbGlnaHRPcHRpb25zOiB7XG4gICAgICAgIGFsbG93T3JpZ2luczogYXBpZ2F0ZXdheS5Db3JzLkFMTF9PUklHSU5TLFxuICAgICAgICBhbGxvd01ldGhvZHM6IGFwaWdhdGV3YXkuQ29ycy5BTExfTUVUSE9EU1xuICAgICAgfVxuICAgIH0pO1xuXG4gICAgLy8gQ3JlYXRlIHJlc291cmNlc1xuICAgIGNvbnN0IHJlc291cmNlcyA9IGFwaS5yb290LmFkZFJlc291cmNlKCdyZXNvdXJjZXMnKTtcbiAgICBjb25zdCBzaW5nbGVSZXNvdXJjZSA9IHJlc291cmNlcy5hZGRSZXNvdXJjZSgne3Jlc291cmNlSWR9Jyk7XG4gICAgY29uc3QgZXh0ZXJuYWxTZWFyY2ggPSBhcGkucm9vdC5hZGRSZXNvdXJjZSgnZXh0ZXJuYWwtc2VhcmNoJyk7XG5cbiAgICAvLyBBZGQgbWV0aG9kc1xuICAgIHJlc291cmNlcy5hZGRNZXRob2QoJ1BPU1QnLCBuZXcgYXBpZ2F0ZXdheS5MYW1iZGFJbnRlZ3JhdGlvbihhZGRSZXNvdXJjZUxhbWJkYSkpO1xuICAgIHJlc291cmNlcy5hZGRNZXRob2QoJ0dFVCcsIG5ldyBhcGlnYXRld2F5LkxhbWJkYUludGVncmF0aW9uKHNlYXJjaFJlc291cmNlc0xhbWJkYSkpO1xuICAgIHNpbmdsZVJlc291cmNlLmFkZE1ldGhvZCgnR0VUJywgbmV3IGFwaWdhdGV3YXkuTGFtYmRhSW50ZWdyYXRpb24oZ2V0UmVzb3VyY2VCeUlkTGFtYmRhKSk7XG4gICAgZXh0ZXJuYWxTZWFyY2guYWRkTWV0aG9kKCdHRVQnLCBuZXcgYXBpZ2F0ZXdheS5MYW1iZGFJbnRlZ3JhdGlvbihwZXJwbGV4aXR5U2VhcmNoTGFtYmRhKSk7XG5cbiAgICAvLyBPdXRwdXQgdGhlIHJlc291cmNlIG5hbWVzIGZvciByZWZlcmVuY2VcbiAgICBuZXcgY2RrLkNmbk91dHB1dCh0aGlzLCAnRHluYW1vREJUYWJsZU5hbWUnLCB7XG4gICAgICB2YWx1ZTogcmVzb3VyY2VzVGFibGUudGFibGVOYW1lLFxuICAgICAgZGVzY3JpcHRpb246ICdUaGUgbmFtZSBvZiB0aGUgRHluYW1vREIgdGFibGUgZm9yIHJlc291cmNlcycsXG4gICAgfSk7XG5cbiAgICBuZXcgY2RrLkNmbk91dHB1dCh0aGlzLCAnUzNCdWNrZXROYW1lJywge1xuICAgICAgdmFsdWU6IHJlc291cmNlTWV0YWRhdGFCdWNrZXQuYnVja2V0TmFtZSxcbiAgICAgIGRlc2NyaXB0aW9uOiAnVGhlIG5hbWUgb2YgdGhlIFMzIGJ1Y2tldCBmb3IgcmVzb3VyY2UgbWV0YWRhdGEnLFxuICAgIH0pO1xuXG4gICAgLy8gQWRkIG91dHB1dHMgZm9yIHRoZSBBUEkgVVJMXG4gICAgbmV3IGNkay5DZm5PdXRwdXQodGhpcywgJ0FwaVVybCcsIHtcbiAgICAgIHZhbHVlOiBhcGkudXJsLFxuICAgICAgZGVzY3JpcHRpb246ICdVUkwgb2YgdGhlIEFQSSBHYXRld2F5J1xuICAgIH0pO1xuICB9XG59Il19